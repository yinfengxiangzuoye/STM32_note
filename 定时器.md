## 定时器概念

定时器顾名思义是**用来定时**的，STM32F1系列产品共有八个定时器，分为基本定时器、通用定时器、高级定时器。其分类的具体情况如下所示：

| 定时器类型 | 定时器              | 计数器位数 | 计数模式             | 预分频系数（整数） | 产生DMA 请求 | 捕获/比较通道 | 互 补输出 |
| ---------- | ------------------- | ---------- | -------------------- | ------------------ | ------------ | ------------- | --------- |
| 基本定时器 | TIM6/TIM7           | 16         | 递增                 | 1~65536            | 可以         | 0             | 无        |
| 通用定时器 | TIM2/TIM3/TIM4/TIM5 | 16         | 递增、递减、中央对齐 | 1~65536            | 可以         | 4             | 无        |
| 高级定时器 | TIM1/TIM8           | 16         | 递增、递减、中央对齐 | 1~65536            | 可以         | 4             | 有        |

基本定时器没有外部IO，只能定时。通用定时器和高级定时器每个定时器分别有有4个/8个外部IO，可以定时、输出比较、输入捕捉等。

## 基本定时器

![image-20250915152238888](./assets/image-20250915152238888.png)

**①定时器时钟源。**定时器时钟 TIMxCLK，即内部时钟 CK_INT，经 APB1总线时钟预分频器后分频提供。

**②控制器。**控制定时器复位、使能、计数，触发DAC转换。

**③时基单元。**包括16bit预分频器PSC，16bit自动重装载寄存器和16bit计数器CNT。计数器工作需要的时钟CK_CNT由定时器时钟经PSC预分频后得到，PSC是个十六位的预分频器，最终计数器时钟计算方法如下：**CK_CNT=TIMxCLK/(PSC+1)**  .计数器 CNT 是一个 16 位的计数器，只能往上计数，最大计数值为 65535。当**计数达到自动重装载寄存器中存的值**的时候产生更新事件，并清零从头开始计数。  自动重装载寄存器 ARR 是一个 16 位的寄存器，这里面装着计数器能计数的最大数值。当计数到这个值的时候，**如果使能了中断的话，定时器就产生溢出中断**。  

### 定时时间计算

计时器计一个数的时间：1/CK_CNT

定时器产生一次溢出中断的时间：(1/CK_CNT) * (ARR+1) = (PSC+1)*(ARR+1)/TIMxCLK 	

Q：为什么是ARR+1？

A：因为计数器是从0开始累计的。

### 注意

在进行实验时发现，基本定时器TIM7的需要使用 HAL_TIM_Base_Start_IT(&htim2); // 启动 + 使能更新中断 来启动定时器计数和使能中断，而外部中断没有这一步。这是因为因为 **EXTI 不是一个“运行型”外设**，它不需要“启动”。

- 定时器需要“启动”是因为它有一个**计数器硬件模块**，不启动就不会工作。
- 而 EXTI 是一个**事件检测控制器**，只要配置好，它就一直在监听指定引脚的边沿变化，无需“启动”。



## 通用定时器



通用/高级定时器只是在基本定时器的基础上添加了一些功能，如基本定时器只有更新事件可以触发中断/DMA请求，而通用高级定时器可以通过更新事件、触发事件、输入捕获、输出比较触发中断/DMA请求。
